# Chamber OS Test Plan (No-CI Phase)

*Prepared by Fred Rogers (RogersTester mode), Feb 25, 2026*

## Why this exists

This project is moving fast and changing real product behavior, but automated testing is still very thin.
We are **not** waiting for CI to start behaving like adults.

This plan defines how to add meaningful test coverage now, locally, with your current toolchain:

- **Vitest** for integration-style and component-adjacent tests
- **Playwright** for end-to-end behavior checks
- **TypeScript compile checks** as a guardrail (`tsc --noEmit`)

---

## Current baseline (observed)

- Existing automated tests are minimal:
  - `tests/int/api.int.spec.ts` (1 integration test)
  - `tests/e2e/admin.e2e.spec.ts` (basic admin navigation)
  - `tests/e2e/frontend.e2e.spec.ts` (basic homepage load)
- Recent feature work has significantly outpaced test additions.
- No CI enforcement yet (acceptable for now), so we need **local quality gates**.

---

## Testing principles for this phase

1. **Risk-first coverage**: test unstable/high-change/high-impact code before low-risk UI polish.
2. **No sandbagging**: tests should prove behavior, not bless implementation details.
3. **Test with intent**: each test should answer “what business behavior would break if this regressed?”
4. **Fast feedback loop**: local suite should be runnable in minutes.
5. **TDD where practical**: for each new feature/fix, write failing test first whenever testability allows.

---

## Scope and priorities (next 2–3 weeks)

### Priority 0 — Test harness hardening (Day 1)

**Goal:** make test runs deterministic and easy to execute.

- Add a test README in `tests/` with:
  - how to run int/e2e
  - env requirements
  - expected local services state
- Ensure `test.env` and seeding assumptions are documented for e2e.
- Define a local pre-push habit (manual):
  - `pnpm tsc --noEmit`
  - `pnpm run test:int`
  - `pnpm run test:e2e` (before merges, not necessarily every save)

### Priority 1 — Core behavior tests (Days 1–3)

**Target files:**
- `src/lib/theme.ts`
- `src/lib/env.ts`
- `src/heros/config.ts`
- `src/lib/features.ts`

**Why first:** these govern global behavior (theme, runtime config validity, hero schema safety, feature toggles).

#### Planned tests

1. **Theme utility tests** (`tests/int/lib/theme.int.spec.ts`)
   - `generateThemeCSS` outputs all required CSS variables.
   - output includes passed theme values for primary/secondary/accent/fonts.
   - `hexToCSS` passthrough behavior is explicit and locked.
   - `DEFAULT_THEME` includes all required keys.

2. **Env parsing tests** (`tests/int/lib/env.int.spec.ts`)
   - valid env parses successfully.
   - missing `DATABASE_URL` fails with helpful error.
   - short `PAYLOAD_SECRET` fails.
   - malformed `NEXT_PUBLIC_SERVER_URL` fails.
   - optional Stripe keys behave as optional unless provided.
   - provided Stripe keys with bad prefixes fail.

   > Note: use module isolation + dynamic import patterns to test import-time parsing safely.

3. **Hero schema tests** (`tests/int/heros/config.int.spec.ts`)
   - hero field is a `group` with expected top-level fields.
   - `type` options include `none`, `minimal`, `fullBleed`.
   - `ctaButtons` has `maxRows: 3`.
   - `overlayOpacity` range remains [0,100].
   - required conditions remain intact for `heading` and `media`.

4. **Feature flag contract tests** (`tests/int/lib/features.int.spec.ts`)
   - expected feature keys exist and are boolean literals.
   - accidental key removals/renames fail tests.

### Priority 2 — Seed/data behavior tests (Days 3–5)

**Target files:**
- `src/endpoints/seed/index.ts`
- `src/endpoints/seed/home.ts`
- `src/endpoints/seed/home-static.ts`

**Why:** seed data changes quickly and can silently break demos, admin setup, and e2e assumptions.

#### Planned tests

1. Seed endpoint returns expected success contract.
2. Seed operation is idempotent (running twice does not explode or duplicate critical globals incorrectly).
3. Required seeded docs/globals exist after seed run.
4. Hero/content assumptions used by frontend tests are guaranteed by seed.

### Priority 3 — Frontend route behavior (Week 2)

**Target files:**
- `src/app/(frontend)/[slug]/page.tsx`
- `src/app/(frontend)/posts/[slug]/page.tsx`
- header/hero rendering paths touched recently

#### Planned e2e tests

1. Published slug route resolves and renders expected heading/hero content.
2. Unknown slug returns 404 UX.
3. Post slug route renders title and core metadata.
4. Header theme behavior remains stable across hero types.

### Priority 4 — Admin workflow tests (Week 2)

Extend current admin e2e beyond navigation:

1. Create a page draft successfully.
2. Set hero type (`fullBleed`) and save.
3. Add CTA buttons and verify constraints (max 3 UI behavior).
4. Publish and verify frontend visibility.

---

## Definition of Done (for this plan window)

This plan is considered complete when:

1. `tests/int/` has meaningful coverage for:
   - theme utils
   - env validation
   - hero schema contract
   - feature flag contract
   - seed behavior
2. `tests/e2e/` includes:
   - at least 3 new frontend behavior tests
   - at least 3 new admin workflow tests
3. Local regression checklist is consistently executable and documented.
4. New feature PRs include tests by default (or explicit written rationale).

---

## Suggested execution cadence (without CI)

- **On each feature branch:** run `tsc` + relevant int tests.
- **Before merge:** run full int + e2e suite.
- **Daily sanity run on main:** run int suite at minimum.

If this cadence is skipped, defects will absolutely sneak in. They always do.

---

## Tracking checklist

- [ ] P0 harness/docs complete
- [ ] P1 core behavior tests implemented
- [ ] P2 seed/data behavior tests implemented
- [ ] P3 frontend route behavior tests implemented
- [ ] P4 admin workflow tests implemented
- [ ] DoD criteria all met

---

## Notes for future CI adoption (later)

When you are ready for CI, this plan maps directly to stages:

1. `typecheck` (`tsc --noEmit`)
2. `test:int`
3. `test:e2e` (possibly split smoke/full)

No redesign needed—just wire the same commands into automation.
